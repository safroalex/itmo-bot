#!/opt/anaconda3/envs/itmo-bot/bin/python
import requests
import json
import time

# URL API Ð²Ð°ÑˆÐµÐ³Ð¾ Ð±Ð¾Ñ‚Ð°
BOT_URL = "http://localhost:8081/api/request"

# ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ = Ð²ÑÐµ)
NUM_TESTS = 1  # Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾, ÐµÑÐ»Ð¸ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ‚ÐµÑÑ‚Ð¾Ð²

# Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¼Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼Ð¸
test_cases = [
    {"id": 1, "query": "Ð’ ÐºÐ°ÐºÐ¾Ð¼ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ðµ (Ð¿Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑŽ Ð½Ð° 2021 Ð³Ð¾Ð´) Ð˜Ð¢ÐœÐž Ð²Ð¿ÐµÑ€Ð²Ñ‹Ðµ Ð²Ð¾ÑˆÑ‘Ð» Ð² Ñ‚Ð¾Ð¿-400 Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ñ… ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð¾Ð²?\n1. ARWU (Shanghai Ranking)\n2. Times Higher Education (THE) World University Rankings\n3. QS World University Rankings\n4. U.S. News & World Report Best Global Universities", "expected_answer": 3},
    {"id": 2, "query": "Ð’ ÐºÐ°ÐºÐ¾Ð¼ Ð³Ð¾Ð´Ñƒ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚ Ð˜Ð¢ÐœÐž Ð±Ñ‹Ð» Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð² Ñ‡Ð¸ÑÐ»Ð¾ ÐÐ°Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ñ… ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð¾Ð² Ð Ð¾ÑÑÐ¸Ð¸?\n1. 2007\n2. 2009\n3. 2011\n4. 2015", "expected_answer": 2},
    {"id": 3, "query": "Ð’ ÐºÐ°ÐºÐ¾Ð¼ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ðµ (Ð¿Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑŽ Ð½Ð° 2021 Ð³Ð¾Ð´) Ð˜Ð¢ÐœÐž Ð²Ð¿ÐµÑ€Ð²Ñ‹Ðµ Ð²Ð¾ÑˆÑ‘Ð» Ð² Ñ‚Ð¾Ð¿-400 Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ñ… ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð¾Ð²?\n1. ARWU (Shanghai Ranking)\n2. Times Higher Education (THE) World University Rankings\n3. QS World University Rankings\n4. U.S. News & World Report Best Global Universities", "expected_answer": 3},
    {"id": 4, "query": "ÐšÐ°ÐºÐ°Ñ Ð±Ñ‹Ð»Ð° Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑƒÑ‡ÐµÐ±Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð¿Ð¾Ð·Ð¶Ðµ ÑÑ‚Ð°Ð»Ð¾ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð¾Ð¼ Ð˜Ð¢ÐœÐž?\n1. Ð’Ð¾ÐµÐ½Ð½Ð°Ñ Ð°ÐºÐ°Ð´ÐµÐ¼Ð¸Ñ\n2. Ð¨ÐºÐ¾Ð»Ð° Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¹ Ð¼ÐµÑ…Ð°Ð½Ð¸ÐºÐ¸ Ð¸ Ð¾Ð¿Ñ‚Ð¸ÐºÐ¸\n3. ÐšÐ°Ñ„ÐµÐ´Ñ€Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸ÐºÐ¸ Ð¸ Ð²Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸\n4. Ð˜Ð½ÑÑ‚Ð¸Ñ‚ÑƒÑ‚ Ñ…Ð¸Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¹", "expected_answer": 2},
    {"id": 5, "query": "ÐšÑ‚Ð¾ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¾ÑÐ½Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ Ð¾Ð´Ð½Ð¾Ð¹ Ð¸Ð· Ð¿ÐµÑ€Ð²Ñ‹Ñ… Ð½Ð°ÑƒÑ‡Ð½Ñ‹Ñ… ÑˆÐºÐ¾Ð» Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð° Ð˜Ð¢ÐœÐž Ð² Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸ Ð¾Ð¿Ñ‚Ð¸ÐºÐ¸?\n1. ÐÐ»ÑŒÐ±ÐµÑ€Ñ‚ Ð­Ð¹Ð½ÑˆÑ‚ÐµÐ¹Ð½\n2. Ð¡ÐµÑ€Ð³ÐµÐ¹ Ð’Ð°Ð²Ð¸Ð»Ð¾Ð²\n3. Ð“ÐµÐ½Ñ€Ð¸Ñ… Ð“ÐµÐ¹Ð½Ðµ\n4. ÐÐ¸ÐºÐ¾Ð»Ð°Ð¹ Ð‘Ð°ÑÐ¾Ð²", "expected_answer": 2},
    {"id": 6, "query": "ÐšÐ°Ðº Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¾Ð´Ð½Ð° Ð¸Ð· ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ñ… Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð° Ð˜Ð¢ÐœÐž?\n1. Ð‘Ð¸Ð¾Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¸\n2. Ð“ÐµÐ½Ð½Ð°Ñ Ð¸Ð½Ð¶ÐµÐ½ÐµÑ€Ð¸Ñ\n3. Ð¤Ð¾Ñ‚Ð¾Ð½Ð¸ÐºÐ° Ð¸ Ð¾Ð¿Ñ‚Ð¾Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸ÐºÐ°\n4. ÐšÐ¾ÑÐ¼Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ", "expected_answer": 3},
    {"id": 7, "query": "Ð’ ÐºÐ°ÐºÐ¾Ð¼ Ð³Ð¾Ñ€Ð¾Ð´Ðµ Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½ Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ ÐºÐ°Ð¼Ð¿ÑƒÑ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚Ð° Ð˜Ð¢ÐœÐž?\n1. ÐœÐ¾ÑÐºÐ²Ð°\n2. Ð¡Ð°Ð½ÐºÑ‚-ÐŸÐµÑ‚ÐµÑ€Ð±ÑƒÑ€Ð³\n3. ÐÐ¾Ð²Ð¾ÑÐ¸Ð±Ð¸Ñ€ÑÐº\n4. ÐšÐ°Ð·Ð°Ð½ÑŒ", "expected_answer": 2},
    {"id": 8, "query": "Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð· Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚ Ð˜Ð¢ÐœÐž Ð¿Ð¾Ð±ÐµÐ¶Ð´Ð°Ð» Ð² ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‡ÐµÑÐºÐ¾Ð¼ Ñ‡ÐµÐ¼Ð¿Ð¸Ð¾Ð½Ð°Ñ‚Ðµ Ð¼Ð¸Ñ€Ð° Ð¿Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ ACM ICPC (Ð´Ð¾ 2020 Ð³Ð¾Ð´Ð°)?\n1. 4 Ñ€Ð°Ð·Ð°\n2. 5 Ñ€Ð°Ð·\n3. 7 Ñ€Ð°Ð·\n4. ÐÐ¸ Ñ€Ð°Ð·Ñƒ", "expected_answer": 3},
    {"id": 9, "query": "Ð’ ÐºÐ°ÐºÐ¾Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸ Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚ Ð˜Ð¢ÐœÐž Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð¸Ð·Ð²ÐµÑÑ‚ÐµÐ½ ÑÐ²Ð¾Ð¸Ð¼Ð¸ Ð½Ð°ÑƒÑ‡Ð½Ñ‹Ð¼Ð¸ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼Ð¸?\n1. Ð¤Ð¸Ð·Ð¸ÐºÐ° Ð²Ñ‹ÑÐ¾ÐºÐ¸Ñ… ÑÐ½ÐµÑ€Ð³Ð¸Ð¹\n2. Ð˜ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ Ð¸ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¾Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°\n3. ÐÑÑ‚Ñ€Ð¾Ð½Ð¾Ð¼Ð¸Ñ Ð¸ Ð°ÑÑ‚Ñ€Ð¾Ñ„Ð¸Ð·Ð¸ÐºÐ°\n4. Ð®Ñ€Ð¸ÑÐ¿Ñ€ÑƒÐ´ÐµÐ½Ñ†Ð¸Ñ Ð¸ Ð¼ÐµÐ¶Ð´ÑƒÐ½Ð°Ñ€Ð¾Ð´Ð½Ð¾Ðµ Ð¿Ñ€Ð°Ð²Ð¾", "expected_answer": 2},
    {"id": 10, "query": "ÐšÐ°ÐºÐ°Ñ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚ Ð˜Ð¢ÐœÐž Ð¾Ñ€Ð¸ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð½Ð° Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½Ð°ÑƒÐºÐ¸ Ð¸ Ð±Ð¸Ð·Ð½ÐµÑÐ°?\n1. StartUp ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°\n2. Ð˜Ð½Ð½Ð¾Ð²Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð¸Ñ Ñ…Ð¸Ð¼Ð¸Ð¸\n3. Art & Science Ð˜Ð½ÑÑ‚Ð¸Ñ‚ÑƒÑ‚\n4. Ð˜Ð½ÑÑ‚Ð¸Ñ‚ÑƒÑ‚ Ð¿ÐµÑ€ÐµÐ´Ð¾Ð²Ñ‹Ñ… Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¹ (Advanced Manufacturing Technologies)", "expected_answer": 4},
]

# ÐžÐ±Ñ€ÐµÐ·Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° NUM_TESTS
test_cases = test_cases[:NUM_TESTS]

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€
start_time = time.time()

# Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
correct = 0
incorrect = 0
detailed_results = []

# Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²
for test in test_cases:
    print("\n=== Running Test ===")
    print(f"ðŸ“ Test ID: {test['id']}")
    print("ðŸ” Question:", test['query'].split("\n")[0], "\n")

    response = requests.post(BOT_URL, json={"query": test["query"], "id": test["id"]})
    
    if response.status_code == 200:
        data = response.json()
        bot_answer = data.get("answer")
        reasoning = data.get("reasoning", "No reasoning provided")
        sources = data.get("sources", [])

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
        is_correct = bot_answer == test["expected_answer"]
        if is_correct:
            correct += 1
        else:
            incorrect += 1

        # Ð›Ð¾Ð³ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
        detailed_results.append({
            "id": test["id"],
            "question": test["query"].split("\n")[0],  # Ð‘ÐµÑ€Ñ‘Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°
            "expected": test["expected_answer"],
            "received": bot_answer,
            "status": "âœ… Correct" if is_correct else "âŒ Incorrect"
        })

        # Ð’Ñ‹Ð²Ð¾Ð´ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð»Ð¾Ð³Ð°
        print(f"âœ… API Response: {json.dumps(data, indent=2, ensure_ascii=False)}")

    else:
        incorrect += 1
        detailed_results.append({
            "id": test["id"],
            "question": test["query"].split("\n")[0],
            "expected": test["expected_answer"],
            "received": f"Error {response.status_code}",
            "status": "âŒ API Error"
        })

        # Ð’Ñ‹Ð²Ð¾Ð´ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
        print(f"âŒ API Error: {response.status_code}")

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€
end_time = time.time()
total_time = end_time - start_time

# Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
print("\n=== Test Results ===")
print(f"âœ… Correct: {correct}")
print(f"âŒ Incorrect: {incorrect}")
print(f"â³ Total execution time: {total_time:.2f} seconds\n")

# Ð’Ñ‹Ñ…Ð¾Ð´ Ñ ÐºÐ¾Ð´Ð¾Ð¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸, ÐµÑÐ»Ð¸ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹
if incorrect > 0:
    exit(1)
else:
    exit(0)
